services:
  database:
    build:
      context: ./db
      dockerfile: Dockerfile
    container_name: file_manager_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: administradorMultimedia
      MYSQL_USER: user
      MYSQL_PASSWORD: root
    ports:
      - "3306:3306"  # Usamos puerto diferente para evitar conflictos con MySQL local
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db/backups:/backups
    networks:
      - file_manager_network

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: file_manager_api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      HOST: database
      USER: root
      PASSWORD: root
      DATABASE: administradorMultimedia
      SECRET_KEY: claveSecretaNoMandarANadie
      MEDIA_PATH: 'asdada'
    ports:
      - "3000:3000"
    volumes:
      # Volumen para archivos subidos
      - uploads_data:/usr/src/app/uploads
      # Volumen para logs
      - api_logs:/usr/src/app/logs
    depends_on:
      - database
    networks:
      - file_manager_network
 
  frontend:
    build:
      context: ./front
      dockerfile: Dockerfile
    container_name: file_manager_frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - api
    networks:
      - file_manager_network

  # Servicio opcional para backup automático de la base de datos
  db_backup:
    image: alpine:latest
    container_name: file_manager_backup
    restart: unless-stopped
    volumes:
      - mysql_data:/backup/mysql:ro
      - ./db/backups:/backups
    entrypoint: |
      sh -c "
      apk add --no-cache mysql-client
      while true; do
        mysqldump -h database -u root -proot administradorMultimedia > /backups/backup_\$(date +%Y%m%d_%H%M%S).sql 2>/backups/error.log || echo 'Error en backup' > /backups/backup_error.log
        ls -tp /backups/*.sql 2>/dev/null | tail -n +8 | xargs -I {} rm -- {} 2>/dev/null
        sleep 86400
      done
      "
    depends_on:
      - database
    networks:
      - file_manager_network
# Definición de volúmenes persistentes
volumes:
  mysql_data:
    name: file_manager_mysql_data
  uploads_data:
    name: file_manager_uploads_data
  api_logs:
    name: file_manager_api_logs

# Red para comunicación entre servicios
networks:
  file_manager_network:
    name: file_manager_network
    driver: bridge